name: PHPUnit Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: none
      - name: Install system deps
        run: sudo apt-get update && sudo apt-get install -y libzip-dev unzip
      - name: Install composer dependencies
        run: composer install --no-progress --no-suggest --prefer-dist
      - name: Copy env
        run: cp .env.example .env && php artisan key:generate
      - name: Run migrations
        run: php artisan migrate --env=testing -vv
      - name: Run tests
        run: vendor/bin/phpunit --testdox

  bdd:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          coverage: none
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libzip-dev unzip curl
      - name: Install composer dependencies (including dev)
        run: composer install --no-progress --no-suggest --prefer-dist
      - name: Copy env
        run: cp .env.example .env && php artisan key:generate
      - name: Run migrations
        run: php artisan migrate --env=testing -vv
      - name: Start built-in server
        run: php artisan serve --host=127.0.0.1 --port=8000 > /dev/null 2>&1 &
      - name: Wait for server
        run: |
          for i in {1..10}; do
            if curl --silent --fail http://127.0.0.1:8000 >/dev/null; then
              echo "Server is up"; break;
            fi
            echo "Waiting for server..."; sleep 2;
          done
      - name: Run Behat
        run: vendor/bin/behat -c behat.yml.dist --strict
